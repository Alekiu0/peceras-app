<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEXKIU FISH | Configurador AI</title>
    <style>
        :root {
            /* Paleta */
            --bg-deep: #020b14;
            --accent-cyan: #00FFFF;
            --accent-blue: #2979ff;
            --accent-green: #00ff9d;
            --accent-purple: #bd00ff;
            --glass-panel: rgba(10, 15, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0f7fa;
            
            /* Variables Geometr√≠a */
            --tank-l: 300px; --tank-h: 200px; --tank-w: 150px;
            --wood-h: 25px; --glass-lid-h: 4px;
            
            /* Tecnopor */
            --tecnopor-h: 10px; 
            --glass-thick: 2px;
            
            /* Materiales */
            --glass-tank-border: rgba(0, 255, 255, 0.4);
            --glass-bg: rgba(200, 255, 255, 0.03);
            --water-color: rgba(0, 255, 255, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100dvh; 
            width: 100vw;
            display: flex;
        }

        /* --- CLASES DE UTILIDAD --- */
        .mobile-liters-badge, 
        .mobile-brand-mini, 
        .mobile-sticky, 
        .mobile-menu-trigger, 
        .mobile-sidebar-header, 
        .mobile-shop-section { 
            display: none; 
        }

        /* --- FONDO ANIMADO --- */
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: radial-gradient(circle at 30% 50%, #0f2540 0%, #020b14 80%);
        }

        /* --- DECORACI√ìN DE FONDO --- */
        .holo-decoration {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 600px; border: 1px solid rgba(0, 255, 255, 0.05);
            border-radius: 50%; z-index: -1; pointer-events: none;
        }
        .holo-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; border: 1px dashed rgba(0, 255, 255, 0.1);
            animation: spin 60s linear infinite;
        }
        .hr-1 { width: 100%; height: 100%; animation-duration: 40s; border-color: rgba(41, 121, 255, 0.1); }
        .hr-2 { width: 70%; height: 70%; animation-duration: 25s; animation-direction: reverse; border-style: dotted; }
        .hr-3 { width: 40%; height: 40%; animation-duration: 15s; border: 2px solid rgba(0, 255, 157, 0.05); }

        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- SUELO DE REJILLA --- */
        .floor-grid {
            position: absolute; top: 60%; left: -50%; width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(70deg);
            z-index: -1;
            mask-image: radial-gradient(circle at 50% 0%, black 0%, transparent 50%);
            -webkit-mask-image: radial-gradient(circle at 50% 0%, black 0%, transparent 50%);
            pointer-events: none;
        }

        /* --- VISUALIZADOR 3D --- */
        .viewer-area {
            position: relative; 
            width: calc(100% - 400px); 
            height: 100%;
            z-index: 1; cursor: grab; perspective: 1800px;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            touch-action: none; 
            /* CENTRADO PERFECTO: Padding inferior para compensar header visualmente */
            padding-bottom: 80px;
        }
        .viewer-area:active { cursor: grabbing; }

        /* HEADER FLOTANTE */
        .floating-header {
            position: absolute; top: 30px; left: 40px; z-index: 10;
            pointer-events: none;
        }
        .brand-title {
            font-size: 4.5rem;
            font-weight: 900; line-height: 0.9; font-style: italic;
            text-transform: uppercase; letter-spacing: -2px;
            background: linear-gradient(180deg, #ffffff 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.5));
            pointer-events: auto;
        }
        .brand-subtitle { 
            font-size: 1.1rem; letter-spacing: 6px; color: var(--accent-blue); 
            margin-left: 5px; font-weight: bold; text-shadow: 0 0 10px rgba(41, 121, 255, 0.5);
        }

        /* --- HISTORIA DE MARCA (IZQUIERDA) --- */
        .brand-story {
            position: absolute; top: 160px; left: 40px; 
            width: 240px; 
            background: linear-gradient(180deg, rgba(0, 10, 20, 0.9) 0%, rgba(0,0,0,0) 100%);
            border-left: 1px solid var(--accent-cyan);
            border-right: 1px solid rgba(255,255,255,0.05);
            padding: 25px 15px;
            z-index: 5; pointer-events: none;
            display: flex; flex-direction: column; gap: 15px;
        }
        
        .bs-title {
            color: #fff; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;
            border-bottom: 1px solid var(--accent-blue); padding-bottom: 8px; margin-bottom: 5px;
        }

        .bs-intro { font-size: 0.85rem; color: #ccc; line-height: 1.5; font-style: italic; }

        .tech-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .tech-item { display: flex; align-items: flex-start; gap: 10px; }
        .ti-icon { 
            color: var(--accent-green); font-size: 1rem; line-height: 1; margin-top: 2px;
            text-shadow: 0 0 5px var(--accent-green);
        }
        .ti-content strong { display: block; color: #fff; font-size: 0.85rem; }
        .ti-content span { display: block; color: #777; font-size: 0.75rem; line-height: 1.2; }

        /* --- LIVE DATA (DERECHA) --- */
        .live-specs {
            position: absolute; top: 160px; right: 440px; width: 240px; 
            background: linear-gradient(180deg, rgba(0, 10, 20, 0.9) 0%, rgba(0,0,0,0) 100%);
            border-right: 1px solid var(--accent-cyan); 
            border-left: 1px solid rgba(255,255,255,0.05);
            padding: 25px 15px; z-index: 5; pointer-events: none;
            display: flex; flex-direction: column; gap: 20px;
            text-align: right; align-items: flex-end;
        }

        .ls-item { display: flex; flex-direction: column; align-items: flex-end; }
        .ls-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2px; }
        .ls-value { 
            font-family: 'Courier New', monospace; font-size: 2.2rem; font-weight: 800; color: #fff; 
            text-shadow: 0 0 10px rgba(255,255,255,0.2); line-height: 0.9;
        }
        .ls-value.highlight { color: var(--accent-cyan); text-shadow: 0 0 15px var(--accent-cyan); }
        .ls-sub { font-size: 0.75rem; color: var(--accent-green); margin-top: 4px; font-weight: bold; letter-spacing: 1px; }


        /* --- CONTROLES FLOTANTES --- */
        .controls-deck {
            position: absolute; bottom: 80px;
            display: flex; gap: 20px; z-index: 20;
            left: 50%; transform: translateX(-50%);
        }

        .control-module {
            background: rgba(10, 15, 25, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px; padding: 12px; width: 140px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .control-module:hover { border-color: var(--accent-cyan); box-shadow: 0 0 20px rgba(0,255,255,0.15); }
        
        .control-module::after {
            content:''; position: absolute; top:0; left:0; height:3px; background: var(--accent-cyan);
            width: var(--progress, 50%); transition: width 0.3s ease;
        }

        .cm-label { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; font-weight: 700; }
        .cm-display { 
            font-size: 2rem; font-weight: 800; color: #fff; font-family: 'Courier New', monospace; 
            margin-bottom: 8px; text-shadow: 0 0 10px rgba(0,255,255,0.2); line-height: 1;
        }
        .cm-unit { font-size: 0.8rem; color: var(--accent-cyan); margin-left: 2px;}
        
        .cm-actions { display: flex; width: 100%; justify-content: space-between; gap: 8px; }
        .cm-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff;
            flex: 1; padding: 6px 0; border-radius: 6px; cursor: pointer;
            font-weight: bold; font-size: 1.1rem; transition: 0.2s;
        }
        .cm-btn:hover { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }
        .cm-btn:active { transform: scale(0.95); }

        /* --- SIDEBAR DERECHO --- */
        .controls-sidebar {
            position: absolute; right: 0; top: 0; height: 100%; width: 400px;
            background: var(--glass-panel); backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            z-index: 25; display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        
        .sidebar-scroll {
            flex: 1; overflow-y: auto; padding: 2rem;
            scrollbar-width: thin; scrollbar-color: var(--accent-cyan) transparent;
        }

        .panel-section { margin-bottom: 2rem; }
        
        /* TITULOS DE ACORDEON (CLASE COMPARTIDA) */
        .panel-title { 
            font-size: 0.8rem; color: #aaa; text-transform: uppercase; 
            letter-spacing: 2px; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px; transition: 0.3s;
        }

        /* CARD IA RECOMENDADOR */
        .ai-card {
            background: linear-gradient(145deg, rgba(0,255,255,0.05), rgba(0,0,0,0.4));
            border: 1px solid rgba(0,255,255,0.2); border-radius: 12px;
            padding: 15px; position: relative; overflow: hidden;
        }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ai-badge { background: var(--accent-cyan); color: #000; font-size: 0.6rem; font-weight: 900; padding: 2px 6px; border-radius: 3px; }
        .ai-icon { font-size: 1.5rem; text-shadow: 0 0 10px var(--accent-cyan); }
        .ai-result h4 { color: #fff; margin: 0; font-size: 1rem; }
        .ai-result p { color: #94a3b8; font-size: 0.8rem; margin: 2px 0 0 0; }
        .ai-price { color: var(--accent-green); font-weight: bold; font-size: 0.9rem; text-align: right; margin-top: 10px; }


        /* ESTILOS DE ARMADO (BOTONES) */
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .toggle-btn {
            flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #aaa; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
            transition: 0.3s; min-width: 80px; text-align: center;
        }
        .toggle-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .toggle-btn.active {
            background: rgba(0, 255, 255, 0.15); border-color: var(--accent-cyan);
            color: #fff; box-shadow: 0 0 10px rgba(0,255,255,0.2) inset; font-weight: bold;
        }

        /* --- BOLETA DIGITAL (RECEIPT) --- */
        .receipt-container {
            background: #000; border: 1px solid #333; border-radius: 8px;
            padding: 20px; position: relative;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .receipt-container::before {
            content: ''; position: absolute; top: -5px; left: 0; width: 100%; height: 5px;
            background: radial-gradient(circle, transparent 50%, #000 50%); background-size: 10px 10px;
            transform: rotate(180deg);
        }
        
        .receipt-header { text-align: center; border-bottom: 1px dashed #555; padding-bottom: 10px; margin-bottom: 15px; color: #888; font-size: 0.7rem; letter-spacing: 2px; }
        
        .receipt-row {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 8px; font-size: 0.85rem; color: #ccc;
        }
        .r-name { max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .r-dots { flex: 1; border-bottom: 1px dotted #444; margin: 0 5px; position: relative; top: -4px; }
        .r-price { color: #fff; }
        
        .receipt-total {
            border-top: 2px solid var(--accent-green);
            margin-top: 15px; padding-top: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rt-label { font-size: 1rem; font-weight: bold; color: var(--accent-green); text-transform: uppercase; }
        .rt-amount { font-size: 1.4rem; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }

        /* --- DELIVERY HIGHLIGHT --- */
        .delivery-highlight {
            background: linear-gradient(90deg, rgba(37, 211, 102, 0.1), transparent);
            border-left: 3px solid #25D366;
            padding: 8px 12px; margin: 15px 0 5px 0;
            display: flex; align-items: center; gap: 10px;
            font-size: 0.85rem; color: #fff; font-weight: bold;
            animation: pulse-border 3s infinite;
        }
        .dh-icon { font-size: 1.2rem; filter: drop-shadow(0 0 5px #25D366); }
        .dh-sub { display: block; font-size: 0.7rem; font-weight: normal; color: #25D366; text-transform: uppercase; letter-spacing: 1px; }

        @keyframes pulse-border {
            0% { box-shadow: -5px 0 10px -5px rgba(37, 211, 102, 0); }
            50% { box-shadow: -5px 0 15px -2px rgba(37, 211, 102, 0.4); }
            100% { box-shadow: -5px 0 10px -5px rgba(37, 211, 102, 0); }
        }

        /* --- STICKY FOOTER BOTON WHATSAPP (PC) --- */
        .summary-sticky {
            background: rgba(0,0,0,0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: auto; 
            z-index: 50;
        }

        .btn-cta {
            width: 100%; background: #25D366; color: #fff; border: none; padding: 14px;
            border-radius: 8px; font-weight: 800; font-size: 1.1rem; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; font-family: 'Segoe UI', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-cta:hover { background: #1ebe57; box-shadow: 0 0 20px rgba(37, 211, 102, 0.6); }
        
        /* Icono SVG Whatsapp */
        .whatsapp-icon-svg {
            width: 24px; height: 24px; fill: white;
        }

        /* TIENDA DRAWER (PARA PC) */
        .shop-drawer {
            position: fixed; bottom: 0; left: 0; 
            width: calc(100% - 400px);
            height: 75vh; z-index: 40;
            background: #0b111a; border-top: 2px solid var(--accent-cyan);
            border-radius: 20px 20px 0 0;
            transform: translateY(calc(100% - 50px));
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
        }
        .shop-drawer.open { transform: translateY(0); }

        .drawer-handle {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 2rem; cursor: pointer; background: linear-gradient(to right, #050f1e, #000);
            border-radius: 18px 18px 0 0;
        }
        .drawer-title { color: #fff; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem;}
        .drawer-arrow { color: var(--accent-cyan); transition: 0.3s; }
        .shop-drawer.open .drawer-arrow { transform: rotate(180deg); }

        .shop-body { flex: 1; overflow-y: auto; padding: 2rem; opacity: 0; transition: 0.2s; }
        .shop-drawer.open .shop-body { opacity: 1; transition-delay: 0.1s; }

        /* DISE√ëO TABS: BLOQUES HUD */
        .shop-tabs { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; 
        }
        .tab-block { 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); 
            color: #94a3b8; padding: 12px 5px; border-radius: 6px; cursor: pointer; 
            transition: 0.3s; text-align: center; font-size: 0.8rem; font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px;
            position: relative; overflow: hidden;
        }
        .tab-block:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-block.active { 
            background: rgba(0, 255, 255, 0.1); color: #fff; 
            border-color: var(--accent-cyan); box-shadow: 0 0 15px rgba(0,255,255,0.15);
        }
        .tab-block.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
            background: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan);
        }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .product-item { 
            background: #0f172a; border: 1px solid #1e293b; 
            border-radius: 10px; padding: 10px; transition: 0.2s; 
        }
        .product-item:hover { border-color: var(--accent-blue); transform: translateY(-3px); }
        
        /* CORRECCI√ìN: Im√°genes cuadradas (1:1) y ajuste "contain" para que no se corten */
        .prod-img { 
            width: 100%; 
            height: auto;
            aspect-ratio: 1 / 1; /* Cuadrado perfecto */
            background: #020617; border-radius: 6px; margin-bottom: 8px; overflow: hidden;
            display: flex; align-items: center; justify-content: center; /* Centrado */
        }
        .prod-img img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* Muestra TODO el producto sin cortar */
            padding: 5px; /* Margen interno para que no toque los bordes */
        }
        
        .prod-title { font-size: 0.85rem; color: #fff; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-price { color: var(--accent-green); font-weight: bold; font-size: 0.9rem; }
        .prod-btn { 
            width: 100%; margin-top: 8px; padding: 6px; background: transparent; 
            border: 1px solid var(--accent-cyan); color: var(--accent-cyan); border-radius: 4px; 
            cursor: pointer; font-size: 0.8rem;
        }
        .prod-btn:hover { background: var(--accent-cyan); color: #000; }

        /* ESTILOS AI RESPONSE */
        .ai-response-area {
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border-left: 2px solid var(--accent-purple);
            padding: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: #d1d5db;
            min-height: 50px;
            white-space: pre-wrap;
            line-height: 1.4;
            position: relative; /* Para bot√≥n cerrar */
        }
        .ai-close-btn {
            position: absolute; top: 5px; right: 5px;
            background: none; border: none; color: #888; font-size: 0.8rem;
            cursor: pointer;
        }
        .ai-close-btn:hover { color: #fff; }

        .loading-spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--accent-purple);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        /* --- VISUALIZADOR 3D --- */
        .scene { position: relative; transform-style: preserve-3d; transform: rotateX(-15deg) rotateY(35deg); transition: transform 0.1s linear; }
        .tank { transform-style: preserve-3d; position: absolute; }
        
        .face { 
            position: absolute; background: var(--glass-bg); 
            border: var(--glass-thick) solid var(--glass-tank-border); 
            box-shadow: 0 0 40px rgba(0,255,255,0.05) inset; backface-visibility: visible; transition: all 0.4s ease; 
            top: 0; left: 0; /* CRITICAL FIX: Ensure 0,0 origin for all faces */
        }

        .f-front { width: var(--tank-l); height: var(--tank-h); transform: translate(-50%, -50%) translateZ(calc(var(--tank-w) / 2)); pointer-events: none; }
        .f-back  { width: var(--tank-l); height: var(--tank-h); transform: translate(-50%, -50%) rotateY(180deg) translateZ(calc(var(--tank-w) / 2)); }
        .f-right { width: var(--tank-w); height: var(--tank-h); transform: translate(-50%, -50%) rotateY(90deg) translateZ(calc(var(--tank-l) / 2)); }
        .f-left  { width: var(--tank-w); height: var(--tank-h); transform: translate(-50%, -50%) rotateY(-90deg) translateZ(calc(var(--tank-l) / 2)); }
        .f-bottom{ width: var(--tank-l); height: var(--tank-w); transform: translate(-50%, -50%) rotateX(-90deg) translateZ(calc(var(--tank-h) / 2)); background: rgba(0,0,0,0.95); border:1px solid #333; }
        
        .water { position: absolute; top: 0; left: 0; transform-style: preserve-3d; }
        .w-face { position: absolute; background: var(--water-color); border: none; pointer-events: none; top:0; left:0; }
        .w-front { width: calc(var(--tank-l) - 4px); height: calc(var(--tank-h) * 0.85); transform: translate(-50%, -50%) translateZ(calc(var(--tank-w) / 2 - 2px)) translateY(calc(var(--tank-h) * 0.075)); }
        .w-back  { width: calc(var(--tank-l) - 4px); height: calc(var(--tank-h) * 0.85); transform: translate(-50%, -50%) rotateY(180deg) translateZ(calc(var(--tank-w) / 2 - 2px)) translateY(calc(var(--tank-h) * 0.075)); }
        .w-right { width: calc(var(--tank-w) - 4px); height: calc(var(--tank-h) * 0.85); transform: translate(-50%, -50%) rotateY(90deg) translateZ(calc(var(--tank-l) / 2 - 2px)) translateY(calc(var(--tank-h) * 0.075)); }
        .w-left  { width: calc(var(--tank-w) - 4px); height: calc(var(--tank-h) * 0.85); transform: translate(-50%, -50%) rotateY(-90deg) translateZ(calc(var(--tank-l) / 2 - 2px)) translateY(calc(var(--tank-h) * 0.075)); }
        .w-top   { width: calc(var(--tank-l) - 4px); height: calc(var(--tank-w) - 4px); transform: translate(-50%, -50%) rotateX(90deg) translateZ(calc((var(--tank-h) * 0.85) / 2 - (var(--tank-h) * 0.075))); background: rgba(0,255,255,0.25); box-shadow: 0 0 50px var(--accent-cyan); }

        .wood-texture { 
            background-color: #4e342e; 
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 12px); 
            /* border removed for seamless join */
        }
        .wood-group { display: none; transform-style: preserve-3d; } .wood-group.visible { display: block; }
        .wood-face { position: absolute; transition: all 0.4s ease; top:0; left:0; /* CRITICAL: Ensure centering works */ }
        
        .wl-front { width: var(--tank-l); height: var(--wood-h); transform: translate(-50%, -50%) translateZ(calc(var(--tank-w) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--wood-h) / 2) * -1 )); }
        .wl-back  { width: var(--tank-l); height: var(--wood-h); transform: translate(-50%, -50%) rotateY(180deg) translateZ(calc(var(--tank-w) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--wood-h) / 2) * -1 )); }
        .wl-right { width: var(--tank-w); height: var(--wood-h); transform: translate(-50%, -50%) rotateY(90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--wood-h) / 2) * -1 )); }
        .wl-left  { width: var(--tank-w); height: var(--wood-h); transform: translate(-50%, -50%) rotateY(-90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--wood-h) / 2) * -1 )); }
        .wl-top   { width: var(--tank-l); height: var(--tank-w); transform: translate(-50%, -50%) rotateX(90deg) translateZ(calc( var(--tank-h) / 2 + var(--wood-h) )); }

        /* BASE PERIMETRAL: Solo Lados, sin fondo (Hollow) */
        .wb-front { width: calc(var(--tank-l) + 2px); height: calc(var(--wood-h) + 1px); transform: translate(-50%, -50%) translateZ(calc(var(--tank-w) / 2)) translateY(calc( var(--tank-h) / 2 + (var(--wood-h) + 1px) / 2 )); }
        .wb-back  { width: calc(var(--tank-l) + 2px); height: calc(var(--wood-h) + 1px); transform: translate(-50%, -50%) rotateY(180deg) translateZ(calc(var(--tank-w) / 2)) translateY(calc( var(--tank-h) / 2 + (var(--wood-h) + 1px) / 2 )); }
        .wb-right { width: var(--tank-w); height: calc(var(--wood-h) + 1px); transform: translate(-50%, -50%) rotateY(90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( var(--tank-h) / 2 + (var(--wood-h) + 1px) / 2 )); }
        .wb-left  { width: var(--tank-w); height: calc(var(--wood-h) + 1px); transform: translate(-50%, -50%) rotateY(-90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( var(--tank-h) / 2 + (var(--wood-h) + 1px) / 2 )); }
        /* .wb-bottom REMOVIDA */

        .glass-group { display: none; transform-style: preserve-3d; } .glass-group.visible { display: block; }
        .glass-face { position: absolute; background: rgba(10, 10, 10, 0.7); border: 1px solid rgba(255,255,255,0.15); transition: all 0.4s ease; top:0; left:0; }
        .gl-front { width: var(--tank-l); height: var(--glass-lid-h); transform: translate(-50%, -50%) translateZ(calc(var(--tank-w) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--glass-lid-h) / 2) * -1 )); }
        .gl-back  { width: var(--tank-l); height: var(--glass-lid-h); transform: translate(-50%, -50%) rotateY(180deg) translateZ(calc(var(--tank-w) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--glass-lid-h) / 2) * -1 )); }
        .gl-right { width: var(--tank-w); height: var(--glass-lid-h); transform: translate(-50%, -50%) rotateY(90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--glass-lid-h) / 2) * -1 )); }
        .gl-left  { width: var(--tank-w); height: var(--glass-lid-h); transform: translate(-50%, -50%) rotateY(-90deg) translateZ(calc(var(--tank-l) / 2)) translateY(calc( (var(--tank-h) / 2 + var(--glass-lid-h) / 2) * -1 )); }
        .gl-top   { width: var(--tank-l); height: var(--tank-w); transform: translate(-50%, -50%) rotateX(90deg) translateZ(calc( var(--tank-h) / 2 + var(--glass-lid-h) )); background: rgba(5, 5, 5, 0.85); }
        .metal-mode .face { border: 8px solid #151515; box-shadow: 0 0 0 1px #333; }

        .aquarium-content { position: absolute; top: 0; left: 0; width: 0; height: 0; transform-style: preserve-3d; pointer-events: none; }
        .fish-wrapper { position: absolute; transform-style: preserve-3d; animation: swim-path 20s linear infinite, float-y 4s ease-in-out infinite; }
        .fish-model { position: relative; transform-style: preserve-3d; }
        .fish-part { position: absolute; backface-visibility: visible; }
        .betta .body { width: 30px; height: 12px; background: var(--fish-color); border-radius: 10px; box-shadow: 0 0 8px var(--fish-color); }
        .betta .tail { width: 45px; height: 35px; background: linear-gradient(90deg, var(--fish-color), transparent); top: -10px; left: -38px; border-radius: 50% 0 0 50%; opacity: 0.9; transform-origin: right center; animation: tail-wag 0.8s ease-in-out infinite alternate; }
        .betta .fin { width: 15px; height: 10px; background: var(--fish-color); top: 8px; left: 5px; transform: rotateX(45deg); opacity: 0.7; }
        .gold .body { width: 34px; height: 24px; background: var(--fish-body-grad); border-radius: 50% 50% 40% 40%; box-shadow: inset -2px -2px 6px rgba(0,0,0,0.2); }
        .gold .tail { width: 28px; height: 32px; background: radial-gradient(circle at right, var(--fish-tail-color), transparent); position: absolute; top: -4px; left: -20px; border-radius: 50% 0 0 50%; opacity: 0.9; transform-origin: right center; animation: tail-wag 0.5s ease-in-out infinite alternate; }
        .gold .dorsal { width: 16px; height: 10px; background: var(--fish-tail-color); position: absolute; top: -8px; left: 10px; border-radius: 50% 50% 0 0; opacity: 0.8; transform: translateZ(0); }
        .gold .pectoral { width: 10px; height: 6px; background: var(--fish-tail-color); position: absolute; top: 14px; left: 18px; opacity: 0.8; animation: fin-flutter 0.2s linear infinite alternate; }
        .gold .pectoral.left { transform: translateZ(2px) rotateY(45deg); }
        .gold .pectoral.right { transform: translateZ(-2px) rotateY(-45deg); }
        @keyframes swim-path {
            0%    { transform: translateX(calc(var(--tank-l) * -0.30)) translateY(calc(var(--tank-h) * var(--ratio-y))) translateZ(calc(var(--tank-w) * var(--ratio-z))) rotateY(0deg); }
            49%   { transform: translateX(calc(var(--tank-l) * 0.30))  translateY(calc(var(--tank-h) * var(--ratio-y))) translateZ(calc(var(--tank-w) * var(--ratio-z))) rotateY(0deg); }
            50%   { transform: translateX(calc(var(--tank-l) * 0.30))  translateY(calc(var(--tank-h) * var(--ratio-y))) translateZ(calc(var(--tank-w) * var(--ratio-z))) rotateY(180deg); }
            99%   { transform: translateX(calc(var(--tank-l) * -0.30)) translateY(calc(var(--tank-h) * var(--ratio-y))) translateZ(calc(var(--tank-w) * var(--ratio-z))) rotateY(180deg); }
            100% { transform: translateX(calc(var(--tank-l) * -0.30)) translateY(calc(var(--tank-h) * var(--ratio-y))) translateZ(calc(var(--tank-w) * var(--ratio-z))) rotateY(0deg); }
        }
        @keyframes float-y { 0%, 100% { margin-top: -5px; } 50% { margin-top: 5px; } }
        @keyframes tail-wag { from { transform: rotateY(20deg); } to { transform: rotateY(-20deg); } }
        @keyframes fin-flutter { from { transform: translateZ(2px) rotateY(30deg); } to { transform: translateZ(2px) rotateY(60deg); } }

        /* --- RESPONSIVE OPTIMIZADO (TABLET Y M√ìVIL) --- */
        @media (max-width: 900px) {
            
            /* 1. OCULTAR ELEMENTOS DE PC */
            .brand-story, .live-specs, .shop-drawer { display: none !important; }

            /* 2. HUD LIMPIO (SOLO BADGES FLOTANTES) */
            .mobile-brand-mini {
                position: absolute; top: 20px; left: 20px;
                font-weight: 900; font-size: 1.4rem; font-style: italic;
                background: linear-gradient(180deg, #ffffff 0%, var(--accent-cyan) 100%);
                -webkit-background-clip: text; background-clip: text; color: transparent;
                z-index: 50; display: block; filter: drop-shadow(0 0 10px rgba(0,255,255,0.3));
            }
            .mobile-liters-badge {
                position: absolute; top: 20px; right: 20px; 
                background: rgba(0,0,0,0.5); padding: 5px 15px;
                border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
                color: #fff; font-weight: bold; font-family: 'Courier New', monospace;
                z-index: 50; display: block; font-size: 1.1rem;
            }

            /* 3. AJUSTE DE PECERA (CENTRO DE ATENCI√ìN) */
            .viewer-area {
                width: 100%; height: 100%; /* Ocupa todo el alto */
                top: 0; display: flex; align-items: center; justify-content: center;
                /* MODIFICACI√ìN: Reducido padding para centrar mejor visualmente */
                padding-bottom: 120px; 
                touch-action: none; /* CRITICO PARA MOVER LA PECERA */
            }
            .scene { 
                /* Escala ligeramente reducida para asegurar que no se corte en pantallas estrechas */
                transform: scale(0.65) rotateX(-10deg) rotateY(35deg) !important; 
            }

            /* 4. CONTROLES DIMENSIONES (UBICADOS CERCA DE COTIZACION) */
            .controls-deck { 
                bottom: 140px; /* Justo encima del precio */
                width: 95%; gap: 5px; z-index: 40;
                justify-content: center;
                background: rgba(0,0,0,0.5); /* Fondo para mejorar legibilidad */
                padding: 10px; border-radius: 12px;
                backdrop-filter: blur(5px);
            }
            .control-module { 
                padding: 5px; background: transparent; 
                border: none; box-shadow: none;
                flex: 1;
            }
            .cm-display { font-size: 1rem; margin-bottom: 2px; }
            .cm-label { display: block; font-size: 0.6rem; margin-bottom: 2px; } /* Mostrar etiquetas peque√±as */
            .cm-btn { padding: 12px 0; font-size: 1.2rem; background: rgba(255,255,255,0.1); }

            /* 5. FOOTER FIJO (PRECIO + CTA) */
            .summary-sticky.mobile-sticky {
                display: flex; flex-direction: column; gap: 8px;
                position: fixed; bottom: 0; width: 100%; 
                padding: 15px 20px 25px 20px; /* Extra padding bottom for iOS home bar */
                background: linear-gradient(to top, #020b14 90%, rgba(2,11,20,0) 100%);
                border-top: 1px solid rgba(255,255,255,0.1); z-index: 100;
            }
            
            .mobile-price-display {
                display: flex; justify-content: space-between; align-items: center;
                color: #fff; font-weight: bold; margin-bottom: 5px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            }
            .mp-label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px;}
            .mp-value { font-size: 1.6rem; color: var(--accent-green); font-family: 'Courier New', monospace; }

            .btn-cta { padding: 16px; font-size: 1.1rem; box-shadow: 0 0 25px rgba(37, 211, 102, 0.2); }

            /* Ajuste del Sidebar Drawer */
            .controls-sidebar {
                position: fixed; bottom: 0; right: 0; left: 0; top: auto;
                width: 100%; height: 85vh; 
                background: #0b111a; border-top: 2px solid var(--accent-cyan);
                border-radius: 20px 20px 0 0;
                transform: translateY(110%); 
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                z-index: 200; /* SUPERIOR */
                box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
                display: flex; flex-direction: column; /* asegurar estructura flex */
            }
            .controls-sidebar.active { transform: translateY(0); }
            
            .mobile-menu-trigger {
                display: flex !important; /* Forzar visibilidad */
                align-items: center; justify-content: center;
                bottom: auto; top: 20px; right: 20px; /* Position top right */
                width: 50px; height: 50px; font-size: 1.5rem;
                background: rgba(10, 20, 30, 0.8); border: 1px solid var(--accent-cyan);
                box-shadow: 0 0 15px rgba(0,255,255,0.3);
                z-index: 250; /* Encima de todo */
                position: fixed;
                border-radius: 50%;
                color: #fff;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            /* Change position when sidebar is active */
            .controls-sidebar.active .mobile-menu-trigger {
                top: 20px; right: 20px;
                background: rgba(255, 50, 50, 0.8);
                border-color: #ff3232;
            }
            
            .mobile-sidebar-header {
                display: flex; align-items: center; justify-content: center;
                padding: 15px; background: #1a253a;
                color: #fff; font-weight: bold; border-radius: 20px 20px 0 0;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }

            /* ESTILOS ACORDEON M√ìVIL */
            .accordion-header {
                display: flex; justify-content: space-between; align-items: center;
                cursor: pointer;
                padding: 15px 10px;
                margin: 0; /* Reset margin */
            }
            .accordion-header::after {
                content: '‚ñº';
                font-size: 0.7rem; color: var(--accent-cyan);
                transition: transform 0.3s;
            }
            .accordion-header.open::after {
                transform: rotate(180deg);
            }
            
            /* Contenido colapsable por defecto en m√≥vil */
            .accordion-content {
                max-height: 0; overflow: hidden;
                transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                padding: 0 5px; /* Slight padding */
            }
            .accordion-content.open {
                max-height: 1000px; /* Arbitrary large number */
            }
            
            /* --- CAMBIO SOLICITADO: GRID M√ìVIL PROPORCIONAL Y COMPACTO --- */
            .products-grid { 
                grid-template-columns: repeat(2, 1fr) !important; /* Fuerza 2 columnas */
                gap: 8px; /* Menor espacio */
            }
            .product-item { padding: 8px; } /* Tarjetas m√°s compactas */
            .sidebar-scroll { padding: 1rem; } /* M√°s espacio lateral para la grilla */

            /* TIENDA INTEGRADA (Solo M√≥vil) */
            .mobile-shop-section { display: block !important; }
        }

        /* Ocultar elementos m√≥viles en PC */
        .mobile-liters-badge, .mobile-brand-mini, .mobile-sticky, .mobile-menu-trigger, .mobile-sidebar-header, .mobile-shop-section { display: none; }
        
        /* Ocultar elementos PC en m√≥vil */
        @media (max-width: 900px) {
            .desktop-only { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="bg-animation"></div>
    
    <!-- ELEMENTOS FLOTANTES M√ìVIL (NUEVO DISE√ëO LIMPIO) -->
    <div class="mobile-brand-mini">ALEXKIU</div>
    <div class="mobile-liters-badge"><span id="mobLitersBadge">0</span> L</div>

    <header class="floating-header">
        <div class="brand-title">ALEXKIU <span style="color:var(--accent-blue); -webkit-text-fill-color: initial;">FISH</span></div>
        <div class="brand-subtitle">CONFIGURADOR PRO AI</div>
    </header>

    <!-- HISTORIA DE MARCA (IZQUIERDA) - Solo PC -->
    <div class="brand-story">
        <div class="bs-title">FILOSOF√çA DE MARCA</div>
        <div class="bs-intro">
            Dise√±amos ecosistemas inteligentes que combinan <b>precisi√≥n industrial</b> con <b>arte acu√°tico</b>.
        </div>
        <ul class="tech-list">
            <li class="tech-item"><span class="ti-icon">üëÅÔ∏è</span><div class="ti-content"><strong>Realidad Aumentada</strong><span>Previsualiza cada componente.</span></div></li>
            <li class="tech-item"><span class="ti-icon">ü§ñ</span><div class="ti-content"><strong>Optimizaci√≥n AI</strong><span>Equilibrio biol√≥gico ideal.</span></div></li>
            <li class="tech-item"><span class="ti-icon">üíé</span><div class="ti-content"><strong>Vidrio Ultra-Clear</strong><span>Transparencia 99%.</span></div></li>
            <li class="tech-item"><span class="ti-icon">üöö</span><div class="ti-content"><strong>Delivery Gratis</strong><span>A todo Per√∫.</span></div></li>
        </ul>
    </div>

    <!-- LIVE DATA (DERECHA) - Solo PC -->
    <div class="live-specs">
        <div class="bs-title" style="border-color:var(--accent-blue); text-align:right;">LIVE DATA</div>
        <div class="ls-item"><span class="ls-label">Volumen Neto</span><span class="ls-value"><span id="liveLiters">240</span> L</span></div>
        <div class="ls-item"><span class="ls-label">Grosor Vidrio</span><span class="ls-value highlight" id="liveThickness">8mm</span><span class="ls-sub">Grado Arquitect√≥nico</span></div>
        <div class="ls-item"><span class="ls-label">Peso Estimado</span><span class="ls-value"><span id="liveWeight">260</span> kg</span></div>
    </div>

    <!-- AREA VISUALIZADOR -->
    <section class="viewer-area" id="viewer">
        <div class="holo-decoration"><div class="holo-ring hr-1"></div><div class="holo-ring hr-2"></div><div class="holo-ring hr-3"></div></div>
        <div class="floor-grid"></div>
        
        <div class="scene" id="scene">
            <div class="tank" id="tank">
                <div class="face f-front"></div><div class="face f-back"></div><div class="face f-right"></div><div class="face f-left"></div><div class="face f-bottom"></div>
                <div class="wood-group" id="woodLidGroup"><div class="wood-face wood-texture wl-front"></div><div class="wood-face wood-texture wl-back"></div><div class="wood-face wood-texture wl-right"></div><div class="wood-face wood-texture wl-left"></div><div class="wood-face wood-texture wl-top"></div></div>
                <div class="glass-group" id="glassLidGroup"><div class="glass-face gl-front"></div><div class="glass-face gl-back"></div><div class="glass-face gl-right"></div><div class="glass-face gl-left"></div><div class="glass-face gl-top"></div></div>
                
                <!-- BASE DE MADERA (NUEVO: SOLO PERIMETRO) -->
                <div class="wood-group" id="woodBaseGroup">
                    <div class="wood-face wood-texture wb-front"></div>
                    <div class="wood-face wood-texture wb-back"></div>
                    <div class="wood-face wood-texture wb-right"></div>
                    <div class="wood-face wood-texture wb-left"></div>
                    <!-- wb-bottom ELIMINADA -->
                </div>

                <div class="aquarium-content" id="lifeContainer"></div>
                <div class="water"><div class="w-face w-front"></div><div class="w-face w-back"></div><div class="w-face w-right"></div><div class="w-face w-left"></div><div class="w-face w-top"></div></div>
            </div>
        </div>

        <!-- MODULOS DE CONTROL (Ahora minimalistas en m√≥vil) -->
        <div class="controls-deck">
            <div class="control-module" id="modL">
                <span class="cm-label">Largo</span>
                <span class="cm-display"><span id="valL">60</span><span class="cm-unit">cm</span></span>
                <div class="cm-actions"><button class="cm-btn" onclick="adjustDim('L', -5)">-</button><button class="cm-btn" onclick="adjustDim('L', 5)">+</button></div>
            </div>
            <div class="control-module" id="modH">
                <span class="cm-label">Alto</span>
                <span class="cm-display"><span id="valH">40</span><span class="cm-unit">cm</span></span>
                <div class="cm-actions"><button class="cm-btn" onclick="adjustDim('H', -5)">-</button><button class="cm-btn" onclick="adjustDim('H', 5)">+</button></div>
            </div>
            <div class="control-module" id="modW">
                <span class="cm-label">Fondo</span>
                <span class="cm-display"><span id="valW">30</span><span class="cm-unit">cm</span></span>
                <div class="cm-actions"><button class="cm-btn" onclick="adjustDim('W', -5)">-</button><button class="cm-btn" onclick="adjustDim('W', 5)">+</button></div>
            </div>
        </div>
    </section>

    <!-- SIDEBAR DERECHO (DRAWER DE CONFIGURACI√ìN EN MOVIL) -->
    <aside class="controls-sidebar">
        <div class="mobile-sidebar-header" onclick="toggleMobileMenu()"><span>‚ñº CERRAR PANEL</span></div>
        <div class="sidebar-scroll">
            
            <!-- CONSULTOR AI -->
            <div class="panel-section">
                <div class="panel-title accordion-header" onclick="toggleAccordion(this)">‚ú® CONSULTOR BIOL√ìGICO AI</div>
                <div class="accordion-content open"> <!-- Abierto por defecto -->
                    <div class="ai-card" style="border-color:var(--accent-purple); background:linear-gradient(145deg, rgba(189, 0, 255, 0.05), rgba(0,0,0,0.4));">
                        <div class="ai-header"><span class="ai-badge" style="background:var(--accent-purple); color:#fff;">GEMINI 2.5 FLASH</span><div class="ai-icon">üß¨</div></div>
                        <p style="font-size:0.8rem; color:#ccc; margin-bottom:10px;">Recomendaci√≥n experta para <b><span id="aiLitersRef">0</span> Litros</b>.</p>
                        <button class="btn-cta" style="background:var(--accent-purple); border:none; font-size:0.8rem;" onclick="askGeminiExpert()">‚ú® GENERAR ECOSISTEMA</button>
                        <div id="aiResponse" class="ai-response-area" style="display:none;">
                            <button class="ai-close-btn" onclick="closeAiResponse()">‚ñº</button>
                            <div id="aiResponseText"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title accordion-header" onclick="toggleAccordion(this)">üõ†Ô∏è PERSONALIZACI√ìN</div>
                <div class="accordion-content">
                    <div style="font-size:0.8rem; color:#888; margin-bottom:5px; margin-top:10px;">ACABADO</div>
                    <div class="btn-group" id="finish-options">
                        <div class="toggle-btn active" onclick="setFinish('rimless', 'Sin Marco')">Sin Marco</div>
                        <div class="toggle-btn" onclick="setFinish('metal', 'Aluminio Negro')">Aluminio</div>
                    </div>
                    <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">TAPA</div>
                    <div class="btn-group" id="lid-options">
                        <div class="toggle-btn active" onclick="setLid('none', 'Sin Tapa')">Sin Tapa</div>
                        <div class="toggle-btn" onclick="setLid('glass', 'Tapa Vidrio')">Vidrio</div>
                        <div class="toggle-btn" onclick="setLid('wood', 'Tapa Madera')">Madera</div>
                    </div>
                    
                    <!-- NUEVA SECCI√ìN BASE -->
                    <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">BASE</div>
                    <div class="btn-group" id="base-options">
                        <div class="toggle-btn active" onclick="setBase('none', 'Sin Base')">Sin Base</div>
                        <div class="toggle-btn" onclick="setBase('wood', 'Base Madera')">Madera</div>
                    </div>
                </div>
            </div>

            <!-- FILTRO -->
            <div class="panel-section">
                <div class="panel-title accordion-header" onclick="toggleAccordion(this)">üß† AN√ÅLISIS T√âCNICO</div>
                <div class="accordion-content">
                    <div class="ai-card">
                        <div class="ai-header"><span class="ai-badge">AI CORE</span><div class="ai-icon">‚öôÔ∏è</div></div>
                        <!-- Added Text -->
                        <div style="font-size:0.7rem; color:#94a3b8; margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;">
                            Recomendaci√≥n IA para <span id="techLitersRef" style="color:var(--accent-cyan); font-weight:bold;">0</span> Litros:
                        </div>
                        <div class="ai-result"><h4 id="recTitle">Calculando...</h4><div class="ai-price" id="filterPriceDisplay">S/ 0</div></div>
                        <button class="btn-cta" style="background:transparent; border:1px solid var(--accent-cyan); color:var(--accent-cyan); padding:5px; margin-top:10px; font-size:0.7rem;" id="btnFilterToggle" onclick="toggleFilter()">AGREGAR</button>
                    </div>
                </div>
            </div>

            <!-- TIENDA INTEGRADA (Solo M√≥vil) -->
            <div class="panel-section mobile-only-section mobile-shop-section">
                <div class="panel-title accordion-header" onclick="toggleAccordion(this)">üõí TIENDA DE ACCESORIOS</div>
                <div class="accordion-content">
                    <div class="shop-tabs">
                        <div class="tab-block active" onclick="loadCategory('food', this)">ALIMENTOS</div>
                        <div class="tab-block" onclick="loadCategory('filters', this)">FILTROS</div>
                        <div class="tab-block" onclick="loadCategory('decor', this)">DECORACI√ìN</div>
                        <div class="tab-block" onclick="loadCategory('substrates', this)">SUSTRATOS</div>
                    </div>
                    <div class="products-grid" id="mobileShopCarousel"></div>
                </div>
            </div>

            <!-- BOLETA -->
            <div class="panel-section">
                <div class="panel-title accordion-header" onclick="toggleAccordion(this)">üßæ DETALLE DE COSTOS</div>
                <div class="accordion-content">
                    <div class="receipt-container">
                        <div class="receipt-header">COTIZACI√ìN #<span id="rndId">001</span></div>
                        <div id="receiptBody"></div>
                        <div class="receipt-total"><span class="rt-label">TOTAL</span><span class="rt-amount" id="totalPrice">S/ 0.00</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STICKY FOOTER PC (Visible solo en desktop) -->
        <div class="summary-sticky desktop-only">
            <button class="btn-cta" onclick="sendToWhatsapp()">
                <svg class="whatsapp-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
                COTIZAR EN WHATSAPP
            </button>
        </div>
    </aside>

    <!-- FOOTER M√ìVIL INTEGRADO (PRECIO + BOT√ìN) -->
    <div class="summary-sticky mobile-sticky">
        <div class="mobile-price-display">
            <span class="mp-label">PRECIO TOTAL:</span>
            <span class="mp-value" id="mobFooterPrice">S/ 0.00</span>
        </div>
        <button class="btn-cta" onclick="sendToWhatsapp()">
            <svg class="whatsapp-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
            COTIZAR AHORA
        </button>
    </div>
    
    <!-- BOT√ìN FLOTANTE M√ìVIL (ENGRANAJE) -->
    <button class="mobile-menu-trigger" onclick="toggleMobileMenu()">‚öôÔ∏è</button>

    <!-- TIENDA DRAWER (VISIBLE EN PC) -->
    <div class="shop-drawer" id="shopDrawer">
        <div class="drawer-handle" id="drawerHandle">
            <span class="drawer-title">üõí Agregar Accesorios</span>
            <span class="drawer-arrow">‚ñ≤</span>
        </div>
        <div class="shop-body">
            <div class="shop-tabs">
                <div class="tab-block active" onclick="loadCategory('food', this)">ALIMENTOS</div>
                <div class="tab-block" onclick="loadCategory('filters', this)">FILTROS</div>
                <div class="tab-block" onclick="loadCategory('decor', this)">DECORACI√ìN</div>
                <div class="tab-block" onclick="loadCategory('substrates', this)">SUSTRATOS</div>
            </div>

            <div class="products-grid" id="shopCarousel"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let currentScale = 6;
            let currentFinish = 'rimless';
            let currentLid = 'none';
            let currentBase = 'none'; // Default sin base
            
            let textFinish = "Sin Marco";
            let textLid = "Sin Tapa";
            let textBase = "Sin Base";

            let cart = [];
            let currentTotal = 0;
            let isFilterIncluded = false; 

            let dimL = 60, dimH = 40, dimW = 30;

            const elDate = document.getElementById('dateDisplay');
            if(elDate) elDate.innerText = new Date().toLocaleDateString();
            
            const elRndId = document.getElementById('rndId');
            if(elRndId) elRndId.innerText = Math.floor(Math.random() * 9000 + 1000);

            const root = document.documentElement;
            const valL = document.getElementById('valL'), valH = document.getElementById('valH'), valW = document.getElementById('valW');
            const modL = document.getElementById('modL'), modH = document.getElementById('modH'), modW = document.getElementById('modW');
            const liveLiters = document.getElementById('liveLiters'), liveThickness = document.getElementById('liveThickness'), liveWeight = document.getElementById('liveWeight');
            
            const tankEl = document.getElementById('tank');
            const woodLidGroup = document.getElementById('woodLidGroup'), glassLidGroup = document.getElementById('glassLidGroup');
            const woodBaseGroup = document.getElementById('woodBaseGroup');
            
            const recTitle = document.getElementById('recTitle'), filterPriceDisplay = document.getElementById('filterPriceDisplay'), btnFilterToggle = document.getElementById('btnFilterToggle');
            const receiptBody = document.getElementById('receiptBody'), totalPriceEl = document.getElementById('totalPrice');
            const lifeContainer = document.getElementById('lifeContainer');

            window.adjustDim = function(axis, amount) {
                if (axis === 'L') { dimL = Math.max(30, Math.min(300, dimL + amount)); } 
                else if (axis === 'H') { dimH = Math.max(20, Math.min(150, dimH + amount)); } 
                else if (axis === 'W') { dimW = Math.max(20, Math.min(100, dimW + amount)); }
                updateTank();
            };

            function updateModuleProgress(mod, val, min, max) {
                if(!mod) return;
                let pct = ((val - min) / (max - min)) * 100;
                mod.style.setProperty('--progress', pct + '%');
            }

            window.setFinish = function(val, text) {
                document.querySelectorAll('#finish-options .toggle-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                currentFinish = val; textFinish = text; updateTank();
            }
            window.setLid = function(val, text) {
                document.querySelectorAll('#lid-options .toggle-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                currentLid = val; textLid = text; updateTank();
            }
            window.setBase = function(val, text) {
                document.querySelectorAll('#base-options .toggle-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                currentBase = val; textBase = text; updateTank();
            }

            window.toggleFilter = function() {
                isFilterIncluded = !isFilterIncluded;
                if(btnFilterToggle) {
                    if(isFilterIncluded) {
                        btnFilterToggle.innerText = "QUITAR";
                        btnFilterToggle.style.borderColor = "#ff4444";
                        btnFilterToggle.style.color = "#ff4444";
                    } else {
                        btnFilterToggle.innerText = "AGREGAR";
                        btnFilterToggle.style.borderColor = "var(--accent-cyan)";
                        btnFilterToggle.style.color = "var(--accent-cyan)";
                    }
                }
                updateTank();
            }

            window.addToCart = function(n, p) { cart.push({name:n, price:p}); updateTank(); };
            window.removeFromCart = function(i) { cart.splice(i, 1); updateTank(); };

            function getBasePrice(vol) {
                if (vol <= 10) return 30;
                if (vol <= 40) return 20 + vol;
                if (vol <= 50) return 60 + ((vol - 40) * 2);
                if (vol <= 60) return 80 + ((vol - 50) * 5);
                if (vol <= 100) return 130 + ((vol - 60) * 2.5);
                if (vol <= 250) return 230 + (vol - 100);
                return 380 + ((vol - 250) * 1.2);
            }

            function getGlassLidPrice(vol) { return vol <= 40 ? 10 : (vol <= 80 ? 20 : (vol <= 150 ? 30 : 40)); }

            window.updateTank = function() {
                if(valL) valL.innerText = dimL; 
                if(valH) valH.innerText = dimH; 
                if(valW) valW.innerText = dimW;
                updateModuleProgress(modL, dimL, 30, 300); updateModuleProgress(modH, dimH, 20, 150); updateModuleProgress(modW, dimW, 20, 100);

                let volume = (dimL * dimH * dimW) / 1000;
                if(liveLiters) liveLiters.innerText = Math.round(volume);
                
                const elAiRef = document.getElementById('aiLitersRef');
                if(elAiRef) elAiRef.innerText = Math.round(volume);
                
                const elMobBadge = document.getElementById('mobLitersBadge');
                if(elMobBadge) elMobBadge.innerText = Math.round(volume);

                // --- NEW: Update Tech Analysis Liters Ref ---
                const elTechLitersRef = document.getElementById('techLitersRef');
                if(elTechLitersRef) elTechLitersRef.innerText = Math.round(volume);

                if(liveWeight) liveWeight.innerText = Math.round(volume + (volume * 0.1));

                let thickPx = 2; let thicknessText = "4mm";
                if(volume <= 60) { thicknessText = "4mm"; thickPx = 2; }
                else if(volume <= 100) { thicknessText = "6mm"; thickPx = 4; }
                else if(volume <= 150) { thicknessText = "8mm"; thickPx = 6; }
                else { thicknessText = "10mm"; thickPx = 8; }
                
                if(liveThickness) liveThickness.innerText = thicknessText;
                root.style.setProperty('--glass-thick', thickPx + 'px');
                root.style.setProperty('--tank-l', (dimL * currentScale) + 'px');
                root.style.setProperty('--tank-h', (dimH * currentScale) + 'px');
                root.style.setProperty('--tank-w', (dimW * currentScale) + 'px');

                if(woodLidGroup) woodLidGroup.classList.remove('visible'); 
                if(glassLidGroup) glassLidGroup.classList.remove('visible');
                if(woodBaseGroup) woodBaseGroup.classList.remove('visible');

                if(currentLid === 'wood' && woodLidGroup) woodLidGroup.classList.add('visible');
                if(currentLid === 'glass' && glassLidGroup) glassLidGroup.classList.add('visible');
                if(currentBase === 'wood' && woodBaseGroup) woodBaseGroup.classList.add('visible');

                if(tankEl) tankEl.classList.toggle('metal-mode', currentFinish === 'metal');

                let filterData = getFilterData(volume);
                if(recTitle) recTitle.innerText = filterData.name;
                if(filterPriceDisplay) filterPriceDisplay.innerText = "S/ " + filterData.price.toFixed(2);
                
                calculateReceipt(volume, thicknessText, filterData);
                generateLife(volume);
            };

            function getFilterData(vol) {
                if (vol < 40) return { name: "Filtro Cascada Mini", price: 45 };
                if (vol < 100) return { name: "Filtro Cascada Med", price: 85 };
                if (vol < 250) return { name: "Canister Externo", price: 380 };
                return { name: "Sump Profesional", price: 650 };
            }

            function calculateReceipt(liters, thicknessText, filterData) {
                let basePrice = getBasePrice(liters);
                let items = [];
                items.push({ n: `Pecera ${liters.toFixed(0)}L (${thicknessText})`, p: basePrice });
                
                if (currentFinish === 'metal') items.push({ n: "Marco Aluminio", p: 100 });
                if (currentLid === 'wood') items.push({ n: "Tapa Madera", p: 115 });
                if (currentLid === 'glass') items.push({ n: "Tapa Vidrio", p: getGlassLidPrice(liters) });
                if (currentBase === 'wood') items.push({ n: "Base Madera", p: 115 });
                
                if (isFilterIncluded) items.push({ n: filterData.name, p: filterData.price });
                cart.forEach((c, i) => items.push({ n: c.name, p: c.price, idx: i }));

                let html = ''; let total = 0;
                items.forEach(item => {
                    total += item.p;
                    let deleteBtn = item.idx !== undefined ? `<span style="color:#f44; cursor:pointer;" onclick="removeFromCart(${item.idx})">[x]</span>` : '';
                    html += `<div class="receipt-row"><span class="r-name">${item.n}</span><span class="r-dots"></span><span class="r-price">S/ ${item.p.toFixed(2)} ${deleteBtn}</span></div>`;
                });
                if(receiptBody) receiptBody.innerHTML = html;
                currentTotal = total;
                if(totalPriceEl) totalPriceEl.innerText = "S/ " + total.toFixed(2);
                
                const elMobPrice = document.getElementById('mobFooterPrice');
                if(elMobPrice) {
                    elMobPrice.innerText = "S/ " + total.toFixed(2);
                }
            }

            // --- FUNCIONALIDAD DE ACORDE√ìN (M√ìVIL) ---
            window.toggleAccordion = function(header) {
                if(window.innerWidth > 900) return; // Solo en m√≥vil

                // Toggle visual state of header (flecha)
                header.classList.toggle('open');

                // Get content sibling
                const content = header.nextElementSibling;
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    content.style.maxHeight = null;
                } else {
                    content.classList.add('open');
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            }
            
            // --- FUNCIONALIDAD TOGGLE AI RESPONSE ---
            window.closeAiResponse = function() {
                const responseArea = document.getElementById('aiResponse');
                if(responseArea) {
                    responseArea.style.display = 'none';
                    responseArea.innerHTML = ''; // Limpiar
                }
            }

            // --- FUNCI√ìN AI EXPERT (Tu versi√≥n validada) ---
            window.askGeminiExpert = async function() {
                const responseArea = document.getElementById('aiResponse');
                if(!responseArea) return;
                
                // 1. OBTENER DATOS REALES DE LA PECERA
                const elLiters = document.getElementById('liveLiters');
                const liters = elLiters ? elLiters.innerText : "0";
                
                // 2. MOSTRAR CARGANDO
                responseArea.style.display = 'block';
                
                // Mantener boton cerrar si es posible o re-agregarlo
                let closeBtnHtml = '<button class="ai-close-btn" onclick="closeAiResponse()">‚ñº</button>';
                responseArea.innerHTML = closeBtnHtml + '<div class="loading-spinner"></div> Consultando al Experto...';
                
                // Ajustar altura acorde√≥n si es necesario (para que se vea el loading)
                const parentContent = responseArea.closest('.accordion-content');
                if(parentContent) {
                      parentContent.style.maxHeight = parentContent.scrollHeight + 500 + "px"; 
                }
                
                // 3. DEFINIR LA PERSONALIDAD (SYSTEM INSTRUCTION)
                const expertSystemInstruction = `
                    Eres el Gerente de Ventas Senior de ALEXKIU FISH. Tu objetivo es maximizar la rentabilidad y garantizar el √©xito del cliente.
        
                    Datos del cliente: Acuario de ${liters} Litros (${dimL}x${dimH}x${dimW}cm).
                    
                    Tus instrucciones de venta (Psicolog√≠a del Consumidor):
                    1.  **Validaci√≥n:** Felicita su dise√±o, diles que esas medidas son "profesionales".
                    2.  **El Dolor (Pain Point):** Advi√©rteles sutilmente que un filtro barato en ${liters}L causar√° agua verde y muerte de peces. Genera "miedo" a la mala calidad.
                    3.  **La Soluci√≥n Premium (Up-selling):**
                        - Si es < 40L: Recomienda "Filtro Cascada XL" (No el mini).
                        - Si es 40L - 150L: Recomienda OBLIGATORIAMENTE un "Canister Externo" (Es el producto m√°s caro y eficiente).
                        - Si es > 150L: Recomienda "Sump Profesional" o doble Canister.
                    4.  **Cierre:** Usa emojis y s√© breve. No des listas largas, da LA MEJOR soluci√≥n.
                    5.  **Tono:** Experto, directo, ligeramente exclusivo.
                `;

                // 4. LA PREGUNTA DEL USUARIO (PROMPT)
                const userPrompt = `Recomi√©ndame una configuraci√≥n completa (peces, plantas, equipo) para esta pecera.`;

                // 4. JUNTAMOS EL MENSAJE PARA EL BACKEND
                const promptCompleto = expertSystemInstruction + "\n\n" + userPrompt;

                try {
                    // --- AQU√ç OCURRE LA MAGIA SEGURA ---
                    // Llamamos a tu carpeta /api/chat en lugar de a Google
                    const response = await fetch('/api/chat', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: promptCompleto 
                        }) 
                    });

                    if (!response.ok) throw new Error('Error al conectar con Vercel');

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "El servidor no devolvi√≥ respuesta.";
                    
                    // 5. MOSTRAR RESULTADO
                    const formattedText = aiText
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<b style="color:var(--accent-cyan)">$1</b>')
                        .replace(/\*/g, '‚Ä¢');
                    
                    responseArea.innerHTML = closeBtnHtml + `<div id="aiResponseText" style="margin-top:15px;">${formattedText}</div>`;
                    
                    // Reajustar altura
                    if(parentContent) parentContent.style.maxHeight = parentContent.scrollHeight + "px";

                } catch (error) {
                    console.error(error);
                    responseArea.innerHTML = closeBtnHtml + '<div style="margin-top:10px;">‚ö†Ô∏è <span style="color:#ff4444">Error:</span> Sube tu proyecto a Vercel para que funcione el Backend.</div>';
                }
            };


            window.sendToWhatsapp = function() {
                let thickness = liveThickness ? liveThickness.innerText : "Standard";
                let liters = liveLiters ? liveLiters.innerText : "0";
                
                let msg = `üöÄ *NUEVA COTIZACI√ìN PREMIUM* üöÄ\n`;
                msg += `Hola ALEXKIU, he dise√±ado mi acuario en el configurador 3D:\n\n`;
                msg += `üíé *ARQUITECTURA*\n`;
                msg += `‚ñ™Ô∏è Dimensiones: *${dimL}x${dimH}x${dimW} cm*\n`;
                msg += `‚ñ™Ô∏è Capacidad: *${liters} Litros* (${thickness})\n`;
                msg += `‚ñ™Ô∏è Estilo: *${textFinish}*\n`;
                msg += `‚ñ™Ô∏è Base: *${textBase}*\n`;
                msg += `‚ñ™Ô∏è Tapa: *${textLid}*\n\n`;

                if(isFilterIncluded || cart.length > 0) {
                    msg += `‚öôÔ∏è *EQUIPAMIENTO & DECO*\n`;
                    if(isFilterIncluded && recTitle) msg += `‚ñ´Ô∏è Filtro: ${recTitle.innerText}\n`;
                    cart.forEach(item => { msg += `‚ñ´Ô∏è ${item.name}\n`; });
                    msg += `\n`;
                }

                msg += `üí∞ *INVERSI√ìN TOTAL: S/ ${currentTotal.toFixed(2)}*\n`;
                msg += `----------------------------------\n`;
                msg += `üìç *ID Cotizaci√≥n:* #${document.getElementById('rndId').innerText}\n`;
                msg += `Quedo atento para confirmar el pedido. ü§ù`;

                window.open(`https://wa.me/51908761978?text=${encodeURIComponent(msg)}`, '_blank');
            };

            function generateLife(liters) {
                if(!lifeContainer) return;
                let targetCount = liters < 60 ? 2 : (liters <= 150 ? 5 : 8); 
                if (lifeContainer.childElementCount === targetCount) return;
                lifeContainer.innerHTML = '';
                for(let i=0; i<targetCount; i++) {
                    const type = Math.random() > 0.6 ? 'betta' : 'gold';
                    const wrapper = document.createElement('div');
                    wrapper.className = 'fish-wrapper';
                    wrapper.style.setProperty('--ratio-y', (Math.random() * 0.6) - 0.25);
                    wrapper.style.setProperty('--ratio-z', (Math.random() * 0.8 - 0.4));
                    wrapper.style.animationDuration = (15 + Math.random()*10) + 's';
                    wrapper.style.animationDelay = (Math.random()*-20) + 's';
                    wrapper.style.transform = `scale(${0.7 + Math.random() * 0.5})`;
                    const model = document.createElement('div');
                    model.className = `fish-model ${type}`;
                    if(type==='betta') {
                        model.style.setProperty('--fish-color', ['#00FFFF', '#FF0000', '#FFFFFF'][Math.floor(Math.random()*3)]);
                        model.innerHTML = `<div class="fish-part body"></div><div class="fish-part tail"></div><div class="fish-part fin"></div>`;
                    } else {
                        model.style.setProperty('--fish-body-grad', 'linear-gradient(to right, #FFD700, #ffffff)');
                        model.style.setProperty('--fish-tail-color', '#FFD700');
                        model.innerHTML = `<div class="fish-part body"></div><div class="fish-part tail"></div><div class="fish-part dorsal"></div><div class="fish-part pectoral left"></div><div class="fish-part pectoral right"></div>`;
                    }
                    wrapper.appendChild(model);
                    lifeContainer.appendChild(wrapper);
                }
            }
            
            window.toggleMobileMenu = function() {
                const sidebar = document.querySelector('.controls-sidebar');
                const trigger = document.querySelector('.mobile-menu-trigger');
                
                // Cerrar tienda si est√° abierta en m√≥vil
                if(window.innerWidth <= 900) {
                      // En m√≥vil, la tienda est√° integrada, no es un drawer separado.
                      // Pero si en el futuro se usa drawer separado, esto previene conflictos.
                }

                if(sidebar) sidebar.classList.toggle('active');
                
                // CAMBIO: Cambiar el icono del bot√≥n en vez de ocultarlo
                if(trigger && sidebar) {
                    if (sidebar.classList.contains('active')) {
                        trigger.innerText = '‚úñ'; // Cambiar a X
                    } else {
                        trigger.innerText = '‚öôÔ∏è'; // Volver a engranaje
                    }
                }
            }

            function determineScale() {
                // Adjust scale calculation based on viewport
                currentScale = window.innerWidth < 900 ? 2.5 : 5.5;
                updateTank();
            }
            window.addEventListener('resize', determineScale);

            // Shop Data Expanded
            const shopData = {
                food: [
                    { n: "Hojuelas Tetra 50g", p: 25, i: "./img/hojuelas.jpg" }, 
                    { n: "Granulado Pro 100g", p: 35, i: "./img/granola.jpg" },
                    { n: "Tubifex Seco 30g", p: 40, i: "./img/tubifex.jpg" },
                    { n: "Pastillas Fondo 50g", p: 30, i: "./img/pastillas.jpg" },
                    { n: "Alimento Betta 10g", p: 15, i: "./img/betta.jpg" },
                    { n: "Espirulina Pura 20g", p: 45, i: "./img/spirulina.jpg" }
                ],
                filters: [
                    { n: "Canister 1200 L/H", p: 450, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Canister" }, 
                    { n: "Filtro Cascada XL", p: 85, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Cascada+XL" },
                    { n: "Filtro Interno 600", p: 45, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Interno" },
                    { n: "Esponja Bio Doble", p: 25, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=BioEsponja" },
                    { n: "Skimmer Superficie", p: 60, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Skimmer" },
                    { n: "Bomba Aire Doble", p: 55, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Oxigeno" }
                ],
                decor: [
                    { n: "Roca Drag√≥n (Kg)", p: 15, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Roca+Dragon" }, 
                    { n: "Tronco Manglar M", p: 45, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Tronco" },
                    { n: "Cueva Cer√°mica", p: 25, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Cueva" },
                    { n: "Barco Hundido", p: 55, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Barco" },
                    { n: "Bonsai Artificial", p: 65, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Bonsai" },
                    { n: "Set Piedras Seiryu", p: 80, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Seiryu" }
                ],
                substrates: [
                    { n: "Sustrato Nutri 3L", p: 60, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Sustrato" }, 
                    { n: "Arena S√≠lice 5Kg", p: 25, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Arena+Silice" },
                    { n: "Grava Negra 5Kg", p: 35, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Grava+Negra" },
                    { n: "Arena Blanca 5Kg", p: 30, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Arena+Blanca" },
                    { n: "Grava Volc√°nica", p: 40, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Volcanica" },
                    { n: "Manado JBL 3L", p: 75, i: "https://via.placeholder.com/160x120/0f2035/00FFFF?text=Manado" }
                ]
            };

            window.loadCategory = function(cat, btn) {
                // Determine container based on visibility/device
                // PC uses 'shopCarousel', Mobile uses 'mobileShopCarousel'
                const pcContainer = document.getElementById('shopCarousel');
                const mobContainer = document.getElementById('mobileShopCarousel');
                
                // Update tabs active state globally
                document.querySelectorAll('.tab-block').forEach(b => {
                    if(b.innerText === btn.innerText) b.classList.add('active');
                    else b.classList.remove('active');
                });

                const fillContainer = (container) => {
                    if(!container) return;
                    container.innerHTML = '';
                    shopData[cat].forEach(prod => {
                        container.innerHTML += `
                            <div class="product-item">
                                <div class="prod-img"><img src="${prod.i}" alt="${prod.n}"></div>
                                <div class="prod-title">${prod.n}</div>
                                <div class="prod-price">S/ ${prod.p.toFixed(2)}</div>
                                <button class="prod-btn" onclick="addToCart('${prod.n}', ${prod.p})">Agregar</button>
                            </div>`;
                    });
                };

                fillContainer(pcContainer);
                fillContainer(mobContainer);
            };
            
            // Initial load for both
            const initialBtn = document.querySelector('.tab-block'); // Just pick one
            if(initialBtn) loadCategory('food', initialBtn);

            // Drawer Handle (PC)
            const drawer = document.getElementById('shopDrawer');
            const handle = document.getElementById('drawerHandle');
            if(handle && drawer) {
                handle.addEventListener('click', () => {
                    drawer.classList.toggle('open');
                });
            }

            // 3D Rotation & PINCH ZOOM
            const viewer = document.getElementById('viewer'), scene = document.getElementById('scene');
            let isDragging = false, startX, startY, rotX = -15, rotY = 35;
            
            // Pinch vars
            let initialPinchDist = 0;
            let initialScaleOnPinch = 0;

            const startDrag = (x, y) => { isDragging = true; startX = x; startY = y; viewer.style.cursor = 'grabbing'; };
            const stopDrag = () => { isDragging = false; viewer.style.cursor = 'grab'; };
            const moveDrag = (x, y) => {
                if(!isDragging) return;
                let dX = x - startX, dY = y - startY;
                rotY += dX * 0.3; rotX -= dY * 0.3;
                rotX = Math.max(-90, Math.min(90, rotX));
                scene.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
                startX = x; startY = y;
            };
            
            if(viewer) {
                // MOUSE EVENTS (PC)
                viewer.addEventListener('mousedown', e => startDrag(e.clientX, e.clientY));
                window.addEventListener('mouseup', stopDrag);
                window.addEventListener('mousemove', e => moveDrag(e.clientX, e.clientY));
                
                // ZOOM RUEDA MOUSE (NUEVO)
                viewer.addEventListener('wheel', e => {
                    if(e.ctrlKey) return; // Permitir zoom normal del navegador si usa Ctrl
                    e.preventDefault();
                    const zoomIntensity = 0.5;
                    const direction = e.deltaY > 0 ? -1 : 1; // Abajo (zoom out), Arriba (zoom in)
                    let newScale = currentScale + (direction * zoomIntensity);
                    newScale = Math.max(1.5, Math.min(10.0, newScale)); // L√≠mites
                    currentScale = newScale;
                    updateTank();
                }, {passive: false});

                // TOUCH EVENTS (MOBILE - PINCH SUPPORT)
                viewer.addEventListener('touchstart', e => {
                    if (e.touches.length === 2) {
                        // Pinch start
                        isDragging = false; // Disable rotation during pinch
                        initialPinchDist = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        initialScaleOnPinch = currentScale;
                    } else if (e.touches.length === 1) {
                        // Drag/Rotate start
                        startDrag(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, {passive: false});

                window.addEventListener('touchend', e => {
                    if (e.touches.length < 2) {
                        initialPinchDist = 0; // Reset pinch
                    }
                    if (e.touches.length === 0) {
                        stopDrag();
                    }
                });

                viewer.addEventListener('touchmove', e => {
                    if (e.touches.length === 2) {
                        // Pinch Zooming
                        e.preventDefault();
                        const dist = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        if (initialPinchDist > 0) {
                            const zoomFactor = dist / initialPinchDist;
                            // Limit scale range to avoid bugs
                            let newScale = initialScaleOnPinch * zoomFactor;
                            newScale = Math.max(1.0, Math.min(8.0, newScale)); 
                            
                            currentScale = newScale;
                            updateTank(); // Redraw with new scale
                        }
                    } else if (e.touches.length === 1 && isDragging) {
                        // Rotation
                        e.preventDefault(); 
                        moveDrag(e.touches[0].clientX, e.touches[0].clientY); 
                    }
                }, {passive: false});
            }

            determineScale();
            updateTank();
        });
    </script>
</body>
</html>